# Beating Blackjack with Reinforcement Learning

## Installing on Warwick DCS machines
```
module load gcc9
cd <PATH>
python3.6 -m venv venv
source <PATH>/venv/bin/activate
pip install -U pip wheel setuptools
pip install -r requirements.txt
python setup.py build_ext --inplace \(to translate Cython code, which is optional\)
```
## Tuning model
As described in `bbwrl/bot/bettors/ml/ddpg_bettor.py`, tuning ddpg bettor requires setting `dtype` to `float64`.

The `scripts/tune.sh` script runs the configurations included in the package, generated by `scripts/generate.sh`. To run other configurations generate new config files similar to the ones in `scripts/tune_config/` and modify `scripts/tune.sh` to use the according files.

```
ssh kudu
cd <PATH>
./scripts/tune.sh
```
## Training model
As described in bbwrl/bot/bettors/ml/ddpg_bettor.py, training ddpg requires setting dtype to float32.

First set up train configs similarly as the ones in `scripts/train_config/` and add these files to for loop in `scripts/train.sh`

```
ssh kudu
cd <PATH>
./scripts/train.sh <#OfNodesToUse>
```
## Simulation
Set up a simulation configuration file similar to the ones included in `scripts/simulate_config/`

```
ssh kudu
cd <PATH>
./scripts/simulate.sh <JobName> <#OfNodesToUse> <PartitionToUse> <ConfigurationPath>
```
## Evaluating a simulation
Generate simulations, which by default will be stored in simulation/. To evaluate these simulations run the following code.

```
module load gcc9
export PYTHONPATH=<PATH>
source <PATH>/venv/bin/activate
cd <PATH>
python bbwrl/evaluator.py simulation/\*
```
Evaluator.py requires the paths of simulation logs, so they can be listed manually as well.
## Results

The results on 900 episodes \(other than for Kelly, which was simulated for 300 episodes\) when stating with a bankroll of 600.0 chips are the following with respect to the approximation for E\[log\(1+r\)\]

| Bettor      | BasicStrategist          | OptimalStrategist       |
| ----------- | ------------------------ | ----------------------- |
| Constant    | -9.14176058263226e-06    | -2.4681096249020366e-06 |
| Vector      | -3.9616658721630907e-07  | 1.6155563911756714e-05  |
| Kelly       | 7.48523145534362e-06     | 3.1125585328481645e-05  |
| DQN         | -9.015988479329113e-06   | -3.4521271904230075e-06 |
| DDPG        | -9.971453194454193e-06   | -3.996055182445184e-06  |

## Management

### Linter
Stylistic errors have been managed using pylint with the configuration file provided by the [Google Python Style Guide](https://google.github.io/styleguide/pyguide.html).

Use: `pylint --rcfile pylintrc bbwrl/`

### Typing
Type safety is provided by annotating every variable, which is checked for by pytype.

Use: `pytype bbwrl/`

### Unit testing
Unit tests are provided to validate that units perform as expected:

Use: `pytest tests/`

## Common issues

The following summarizes the common issues when running the program.

### No module named 'bbwrl'

`ModuleNotFoundError: No module named 'bbwrl'`

This error is present, when the location of the project was not exported to PYTHONPATH. Fix by running `export PYTHONPATH=<path_to_project>`.


### CXXABI_1.3.9

`ImportError: /lib64/libstdc++.so.6: version 'CXXABI_1.3.9' not found.`

This error is present, when the code is run with the wrong gcc version. Fix it by calling `module load gcc9`.

### SytaxError, ModuleNotFoundError

This happens when the code can't find a required module. Try activating the virtual environment or installing the required module.

### TypeError

`TypeError: Input 'y' of 'AddV2' Op has type float32 that does not match type float64 of argument 'x'.`

This error is present when running the ML bettors with the wrong dtype. As explained in the DDPGBettor.py source file, for tuning purposes every dtype needs to be changed to `float64` and for training purposes every dtype needs to be changed to `float32`. The dtype does not need to be changed for the DQNBettor.
